{% extends "DnDSite/base.html" %}
{% load dnd_filters %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monster_detail.css' %}">
{% endblock %}

{% block extra_js %}
<script src="/static/js/monster_detail.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'monster_list' %}{% if monster.is_homebrew %}?show_homebrew=true{% endif %}"
           class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>

        <div class="btn-group">
            {% if user.is_authenticated %}
            <button class="btn btn-outline-warning favorite-btn"
                    data-type="monster"
                    data-id="{{ monster.id }}"
                    data-action="add"
                    id="favoriteBtn">
                <i class="bi bi-star"></i>
                <span id="favoriteText">В избранное</span>
            </button>
            {% endif %}

            {% if request.user.is_staff or request.user == monster.created_by %}
            <a href="{% url 'edit_monster' monster.id %}" class="btn btn-outline-warning">
                <i class="bi bi-pencil"></i> Редактировать
            </a>
            {% if request.user.is_staff and monster.is_homebrew %}
            <a href="{% url 'delete_monster' monster.id %}" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Удалить
            </a>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="text-center mb-4">
        {% if monster.is_homebrew %}
        <div class="d-inline-flex align-items-center mb-3">
            <i class="bi bi-stars me-2 fs-5"></i>
            <div class="text-start">
                <strong class="d-block">Homebrew контент</strong>
                {% if monster.created_by %}
                <small>Автор: {{ monster.created_by.username }}</small>
                {% endif %}
                {% if not monster.is_approved %}
                <span class="badge bg-warning text-dark ms-2">Ожидает одобрения администратора</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <h1 class="display-5 fw-bold">{{ monster.name }}</h1>
        <div class="d-flex justify-content-center gap-3 mt-3">
            <span class="badge bg-primary fs-6">
                <i class="bi bi-rulers"></i>
                {% if monster.size == 'Tiny' %}Крошечный
                {% elif monster.size == 'Small' %}Маленький
                {% elif monster.size == 'Medium' %}Средний
                {% elif monster.size == 'Large' %}Большой
                {% elif monster.size == 'Huge' %}Огромный
                {% elif monster.size == 'Gargantuan' %}Гигантский
                {% else %}{{ monster.size }}{% endif %}
            </span>
            <span class="badge bg-success fs-6">
                <i class="bi bi-tags"></i> {{ monster.type }}
            </span>
            <span class="badge bg-danger fs-6">
                <i class="bi bi-heart"></i> {{ monster.hit_points }} HP
            </span>
        </div>
    </div>

    <div class="card shadow-lg border-0">
        <div class="row g-0">
            <div class="col-lg-8">
                <div class="p-4">
                    <h3 class="border-bottom pb-2 mb-4">Характеристики</h3>

                    <div class="row row-cols-2 row-cols-md-3 g-4">
                        {% with monster as m %}
                        <div class="col">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary text-white text-center py-2">
                                    <strong>Сила</strong>
                                </div>
                                <div class="card-body text-center py-3">
                                    <div class="display-6 fw-bold">{{ m.strength }}</div>
                                    <div class="text-muted">Модификатор:
                                        <span class="fw-bold {% if strength_mod > 0 %}text-success{% elif strength_mod < 0 %}text-danger{% endif %}">
                                            {% if strength_mod >= 0 %}+{% endif %}{{ strength_mod }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white text-center py-2">
                                    <strong>Ловкость</strong>
                                </div>
                                <div class="card-body text-center py-3">
                                    <div class="display-6 fw-bold">{{ m.dexterity }}</div>
                                    <div class="text-muted">Модификатор:
                                        <span class="fw-bold {% if dexterity_mod > 0 %}text-success{% elif dexterity_mod < 0 %}text-danger{% endif %}">
                                            {% if dexterity_mod >= 0 %}+{% endif %}{{ dexterity_mod }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 border-danger">
                                <div class="card-header bg-danger text-white text-center py-2">
                                    <strong>Телосложение</strong>
                                </div>
                                <div class="card-body text-center py-3">
                                    <div class="display-6 fw-bold">{{ m.constitution }}</div>
                                    <div class="text-muted">Модификатор:
                                        <span class="fw-bold {% if constitution_mod > 0 %}text-success{% elif constitution_mod < 0 %}text-danger{% endif %}">
                                            {% if constitution_mod >= 0 %}+{% endif %}{{ constitution_mod }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 border-info">
                                <div class="card-header bg-info text-white text-center py-2">
                                    <strong>Интеллект</strong>
                                </div>
                                <div class="card-body text-center py-3">
                                    <div class="display-6 fw-bold">{{ m.intelligence }}</div>
                                    <div class="text-muted">Модификатор:
                                        <span class="fw-bold {% if intelligence_mod > 0 %}text-success{% elif intelligence_mod < 0 %}text-danger{% endif %}">
                                            {% if intelligence_mod >= 0 %}+{% endif %}{{ intelligence_mod }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning text-dark text-center py-2">
                                    <strong>Мудрость</strong>
                                </div>
                                <div class="card-body text-center py-3">
                                    <div class="display-6 fw-bold">{{ m.wisdom }}</div>
                                    <div class="text-muted">Модификатор:
                                        <span class="fw-bold {% if wisdom_mod > 0 %}text-success{% elif wisdom_mod < 0 %}text-danger{% endif %}">
                                            {% if wisdom_mod >= 0 %}+{% endif %}{{ wisdom_mod }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 border-secondary">
                                <div class="card-header bg-secondary text-white text-center py-2">
                                    <strong>Харизма</strong>
                                </div>
                                <div class="card-body text-center py-3">
                                    <div class="display-6 fw-bold">{{ m.charisma }}</div>
                                    <div class="text-muted">Модификатор:
                                        <span class="fw-bold {% if charisma_mod > 0 %}text-success{% elif charisma_mod < 0 %}text-danger{% endif %}">
                                            {% if charisma_mod >= 0 %}+{% endif %}{{ charisma_mod }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                    <div class="mt-5">
                        <h4 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-shield"></i> Классы брони
                        </h4>
                        {% if armor_classes %}
                        <div class="row g-3">
                            {% for armor in armor_classes %}
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="card-title mb-1">{{ armor.get_type_display }}</h5>
                                                <p class="card-text text-muted mb-0 small">
                                                    {% if armor.type == 'natural' %}Природная защита
                                                    {% elif armor.type == 'armor' %}За счёт доспеха
                                                    {% elif armor.type == 'magic' %}Магическая защита
                                                    {% elif armor.type == 'dex' %}Ловкость
                                                    {% else %}Прочая защита{% endif %}
                                                </p>
                                            </div>
                                            <span class="badge bg-primary fs-4 px-3 py-2">{{ armor.value }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Класс брони не указан</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-4 bg-light">
                <div class="p-4 h-100">
                    <div class="mb-5">
                        <h4 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-speedometer2"></i> Скорость
                        </h4>
                        {% if speeds %}
                        <div class="list-group">
                            {% for speed in speeds %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ speed.movement_type|get_movement_display }}</strong>
                                </div>
                                <span class="badge bg-success rounded-pill fs-6">{{ speed.value }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Скорость не указана</p>
                        {% endif %}
                    </div>
                    <div class="mb-5">
                        <h4 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-bar-chart"></i> Статистика
                        </h4>
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th scope="row">Здоровье</th>
                                    <td class="text-end">
                                        <strong>{{ monster.hit_points }}</strong> HP
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Размер</th>
                                    <td class="text-end">
                                        {% if monster.size == 'Tiny' %}Крошечный
                                        {% elif monster.size == 'Small' %}Маленький
                                        {% elif monster.size == 'Medium' %}Средний
                                        {% elif monster.size == 'Large' %}Большой
                                        {% elif monster.size == 'Huge' %}Огромный
                                        {% elif monster.size == 'Gargantuan' %}Гигантский
                                        {% else %}{{ monster.size }}{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Тип</th>
                                    <td class="text-end">{{ monster.type }}</td>
                                </tr>
                                {% if monster.created_at %}
                                <tr>
                                    <th scope="row">Добавлен</th>
                                    <td class="text-end">{{ monster.created_at|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-calculator"></i> Модификаторы навыков
                        </h4>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Навык</th>
                                        <th class="text-end">Модификатор</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Атлетика (СИЛ)</td>
                                        <td class="text-end {% if strength_mod > 0 %}text-success{% elif strength_mod < 0 %}text-danger{% endif %}">
                                            {% if strength_mod >= 0 %}+{% endif %}{{ strength_mod }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Акробатика (ЛОВ)</td>
                                        <td class="text-end {% if dexterity_mod > 0 %}text-success{% elif dexterity_mod < 0 %}text-danger{% endif %}">
                                            {% if dexterity_mod >= 0 %}+{% endif %}{{ dexterity_mod }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Магия (ИНТ)</td>
                                        <td class="text-end {% if intelligence_mod > 0 %}text-success{% elif intelligence_mod < 0 %}text-danger{% endif %}">
                                            {% if intelligence_mod >= 0 %}+{% endif %}{{ intelligence_mod }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Восприятие (МДР)</td>
                                        <td class="text-end {% if wisdom_mod > 0 %}text-success{% elif wisdom_mod < 0 %}text-danger{% endif %}">
                                            {% if wisdom_mod >= 0 %}+{% endif %}{{ wisdom_mod }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Убеждение (ХАР)</td>
                                        <td class="text-end {% if charisma_mod > 0 %}text-success{% elif charisma_mod < 0 %}text-danger{% endif %}">
                                            {% if charisma_mod >= 0 %}+{% endif %}{{ charisma_mod }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer bg-dark text-white">
            <div class="row">
                <div class="col-md-4 text-center">
                    <small class="text-light">Сложность боя (приблизительно)</small>
                    <div class="fs-4 fw-bold">
                        {% with hp=monster.hit_points %}
                        {% if hp < 50 %}Легко
                        {% elif hp < 100 %}Средне
                        {% elif hp < 200 %}Сложно
                        {% else %}Очень сложно
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <small class="text-light">Предполагаемый уровень</small>
                    <div class="fs-4 fw-bold">
                        {% with hp=monster.hit_points %}
                        {% if hp < 30 %}1-3
                        {% elif hp < 60 %}4-6
                        {% elif hp < 100 %}7-9
                        {% elif hp < 150 %}10-12
                        {% elif hp < 200 %}13-15
                        {% else %}16+
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <small class="text-light">Опыт за победу</small>
                    <div class="fs-4 fw-bold">
                        {% with hp=monster.hit_points %}
                        {% if hp < 30 %}~100 XP
                        {% elif hp < 60 %}~200 XP
                        {% elif hp < 100 %}~450 XP
                        {% elif hp < 150 %}~700 XP
                        {% elif hp < 200 %}~1100 XP
                        {% else %}~1800 XP
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if user.is_authenticated and not monster.is_homebrew %}
    <div class="text-center mt-4">
        <div class="card border-success">
            <div class="card-body">
                <h5 class="card-title text-success">
                    <i class="bi bi-lightbulb"></i> Вдохновились этим монстром?
                </h5>
                <p class="card-text">
                    Создайте свою версию или вариант этого монстра как Homebrew контент!
                </p>
                <a href="{% url 'add_monster' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Создать свой вариант
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="mt-5">
        <h3 class="border-bottom pb-2 mb-4">
            <i class="bi bi-arrow-right-circle"></i> Похожие монстры
        </h3>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% if similar_monsters %}
                {% for similar in similar_monsters %}
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="{% url 'monster_detail' similar.id %}" class="text-decoration-none">
                                    {{ similar.name }}
                                </a>
                            </h5>
                            <div class="mb-2">
                                <span class="badge bg-primary">
                                    {% if similar.size == 'Tiny' %}Крошечный
                                    {% elif similar.size == 'Small' %}Маленький
                                    {% elif similar.size == 'Medium' %}Средний
                                    {% elif similar.size == 'Large' %}Большой
                                    {% elif similar.size == 'Huge' %}Огромный
                                    {% elif similar.size == 'Gargantuan' %}Гигантский
                                    {% else %}{{ similar.size }}{% endif %}
                                </span>
                                <span class="badge bg-success">{{ similar.type }}</span>
                            </div>
                            <div class="text-muted small">
                                <div><strong>Здоровье:</strong> {{ similar.hit_points }} HP</div>
                                <div><strong>Сила:</strong> {{ similar.strength }}</div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{% url 'monster_detail' similar.id %}" class="btn btn-sm btn-outline-primary">
                                Подробнее
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="col-12">
                <p class="text-muted">Похожие монстры не найдены.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}