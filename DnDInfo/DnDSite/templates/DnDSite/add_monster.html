{% extends "DnDSite/base.html" %}
{% load static %}

{% block title %}Добавить монстра{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/add_monster.css' %}">
{% endblock %}

<!--{% block extra_js %}-->
<!--<script src="{% static 'js/add_monster.js' %}"></script>-->
<!--{% endblock %}-->

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-plus-circle text-success"></i> Добавить нового монстра
            </h1>
            <p class="lead text-muted">Создайте собственного монстра для вашей кампании D&D</p>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow border-0">
                <div class="card-body p-4">
                    <form method="post" id="monsterForm" novalidate>
                        {% csrf_token %}
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" name="name" class="form-control" id="id_name"
                                           placeholder="Название монстра" required>
                                    <label for="id_name">Название</label>
                                    {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.name.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select name="size" class="form-select" id="id_size" required>
                                        <option value="" selected>Выберите размер</option>
                                        <option value="Tiny">Крошечный</option>
                                        <option value="Small">Маленький</option>
                                        <option value="Medium">Средний</option>
                                        <option value="Large">Большой</option>
                                        <option value="Huge">Огромный</option>
                                        <option value="Gargantuan">Гигантский</option>
                                    </select>
                                    {% if form.size.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.size.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating mb-3">
                                    <input type="text" name="type" class="form-control" id="id_type"
                                           placeholder="Тип монстра" required>
                                    <label for="id_type">Тип</label>
                                    <div class="form-text">Например: дракон, гуманоид, нежить, зверь и т.д.</div>
                                    {% if form.type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.type.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="hit_points" class="form-control" id="id_hit_points"
                                           placeholder="Уровни жизней" min="1" required>
                                    <label for="id_hit_points">Уровни жизней (HP)</label>
                                    <div class="form-text">Количество хитов</div>
                                    {% if form.hit_points.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.hit_points.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <h4 class="mt-5 mb-3 border-bottom pb-2">
                            Характеристики
                        </h4>

                        <div class="row g-3">
                            <div class="col-md-4 col-lg-2">
                                <div class="form-floating mb-3">
                                    <input type="number" name="strength" class="form-control stat-input"
                                           id="id_strength" placeholder="Сила" min="1" max="30" required>
                                </div>
                            </div>

                            <div class="col-md-4 col-lg-2">
                                <div class="form-floating mb-3">
                                    <input type="number" name="dexterity" class="form-control stat-input"
                                           id="id_dexterity" placeholder="Ловкость" min="1" max="30" required>
                                </div>
                            </div>

                            <div class="col-md-4 col-lg-2">
                                <div class="form-floating mb-3">
                                    <input type="number" name="constitution" class="form-control stat-input"
                                           id="id_constitution" placeholder="Телосложение" min="1" max="30" required>
                                </div>
                            </div>

                            <div class="col-md-4 col-lg-2">
                                <div class="form-floating mb-3">
                                    <input type="number" name="intelligence" class="form-control stat-input"
                                           id="id_intelligence" placeholder="Интеллект" min="1" max="30" required>
                                </div>
                            </div>

                            <div class="col-md-4 col-lg-2">
                                <div class="form-floating mb-3">
                                    <input type="number" name="wisdom" class="form-control stat-input"
                                           id="id_wisdom" placeholder="Мудрость" min="1" max="30" required>
                                </div>
                            </div>

                            <div class="col-md-4 col-lg-2">
                                <div class="form-floating mb-3">
                                    <input type="number" name="charisma" class="form-control stat-input"
                                           id="id_charisma" placeholder="Харизма" min="1" max="30" required>
                                </div>
                            </div>
                        </div>

                        <h4 class="mt-5 mb-3 border-bottom pb-2">
                            <i class="bi bi-shield"></i> Класс брони
                        </h4>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select name="armor-type" class="form-select" id="id_armor_type">
                                        <option value="natural" selected>Природная броня</option>
                                        <option value="armor">Доспехи</option>
                                        <option value="magic">Магическая защита</option>
                                        <option value="dex">Ловкость</option>
                                        <option value="other">Другое</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="armor-value" class="form-control"
                                           id="id_armor_value" placeholder="Значение брони" min="0">
                                    <label for="id_armor_value">Значение брони</label>
                                </div>
                            </div>
                        </div>

                        <h4 class="mt-5 mb-3 border-bottom pb-2">
                            <i class="bi bi-speedometer2"></i> Скорость
                        </h4>

                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-floating mb-3">
                                    {{ speeds_form.speeds }}

                                    <div class="form-text">
                                        {{ speeds_form.speeds.help_text|safe }}
                                        Примеры:<br>
                                        <code>walk: 30</code> - Ходьба: 30 футов<br>
                                        <code>fly: 30</code> - Полёт: 30 футов<br>
                                        <code>swim: 20</code> - Плавание: 20 футов<br>
                                        <code>climb: 30</code> - Лазание: 30 футов<br>
                                        <code>burrow: 10</code> - Рытьё: 10 футов<br>
                                        <code>dig: 10</code> - Капая: 10 футов<br>
                                        <code>hover: 0</code> - Парение (не требует перемещения)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-5">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save"></i> Сохранить монстра
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Советы по созданию монстра</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="bi bi-1-circle"></i> Баланс характеристик</h6>
                            <p class="small">Значения характеристик от 1 до 30. Среднее значение - 10.</p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="bi bi-2-circle"></i> Класс брони</h6>
                            <p class="small">AC 10-12 - слабая защита, 13-15 - средняя, 16+ - высокая.</p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="bi bi-3-circle"></i> Здоровье</h6>
                            <p class="small">Низкое: 1-30, Среднее: 31-100, Высокое: 101+ HP.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const statInputs = document.querySelectorAll('.stat-input');

    function calculateModifier(value) {
        return Math.floor((value - 10) / 2);
    }

    function updateModifierDisplay(input) {
        const value = parseInt(input.value) || 0;
        const modifier = calculateModifier(value);
        const label = input.parentElement.querySelector('label');
        const modifierText = modifier >= 0 ? `+${modifier}` : modifier.toString();
        const existingModifier = label.querySelector('.modifier-badge');

        if (existingModifier) {
            existingModifier.remove();
        }

        const badge = document.createElement('span');
        badge.className = `modifier-badge badge ms-2 ${modifier >= 0 ? 'bg-success' : 'bg-danger'}`;
        badge.textContent = modifierText;
        label.appendChild(badge);
    }
    statInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateModifierDisplay(this);
        });

        if (input.value) {
            updateModifierDisplay(input);
        }
    });
    const form = document.getElementById('monsterForm');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        const errorMessages = [];
        const requiredInputs = form.querySelectorAll('input[required], select[required]');
        requiredInputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add('is-invalid');
                errorMessages.push(`Поле "${input.previousElementSibling?.textContent || 'Неизвестное поле'}" обязательно для заполнения`);
            } else {
                input.classList.remove('is-invalid');
            }
        });
        const numberInputs = form.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            if (input.value) {
                const value = parseInt(input.value);
                const min = parseInt(input.min) || -Infinity;
                const max = parseInt(input.max) || Infinity;

                if (value < min || value > max) {
                    isValid = false;
                    input.classList.add('is-invalid');
                    errorMessages.push(`Значение в поле "${input.previousElementSibling?.textContent || 'Неизвестное поле'}" должно быть от ${min} до ${max}`);
                }
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Пожалуйста, исправьте следующие ошибки:\n\n' + errorMessages.join('\n'));
        }
    });
    statInputs.forEach(input => {
        input.addEventListener('mouseenter', function() {
            const value = parseInt(this.value) || 0;
            const modifier = calculateModifier(value);
            const tooltipText = `Модификатор: ${modifier >= 0 ? '+' : ''}${modifier}`;
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip bs-tooltip-top';
            tooltip.innerHTML = `
                <div class="tooltip-arrow"></div>
                <div class="tooltip-inner">${tooltipText}</div>
            `;

            const rect = this.getBoundingClientRect();
            tooltip.style.position = 'fixed';
            tooltip.style.top = (rect.top - 40) + 'px';
            tooltip.style.left = (rect.left + rect.width/2) + 'px';
            tooltip.style.transform = 'translateX(-50%)';

            this.tooltipElement = tooltip;
            document.body.appendChild(tooltip);
        });

        input.addEventListener('mouseleave', function() {
            if (this.tooltipElement) {
                this.tooltipElement.remove();
                this.tooltipElement = null;
            }
        });
    });
    function autoFillStats() {
        const autoFillBtn = document.createElement('button');
        autoFillBtn.type = 'button';
        autoFillBtn.className = 'btn btn-sm btn-outline-secondary mb-3';
        autoFillBtn.innerHTML = '<i class="bi bi-magic"></i> Заполнить стандартные значения';
        autoFillBtn.onclick = function() {
            document.getElementById('id_strength').value = 10;
            document.getElementById('id_dexterity').value = 10;
            document.getElementById('id_constitution').value = 10;
            document.getElementById('id_intelligence').value = 10;
            document.getElementById('id_wisdom').value = 10;
            document.getElementById('id_charisma').value = 10;
            statInputs.forEach(input => updateModifierDisplay(input));
        };

        const statsSection = document.querySelector('.border-bottom + .row');
        statsSection.parentNode.insertBefore(autoFillBtn, statsSection);
    }
    autoFillStats();
});
</script>

{% endblock %}